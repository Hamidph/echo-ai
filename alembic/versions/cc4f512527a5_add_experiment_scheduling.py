"""add_experiment_scheduling

Revision ID: cc4f512527a5
Revises: 004_add_iteration_status_index
Create Date: 2026-01-05 16:57:58.616990

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'cc4f512527a5'
down_revision: Union[str, Sequence[str], None] = '004_add_iteration_status_index'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('api_keys', 'prefix',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.String(length=20),
               comment="Display prefix of key (e.g., 'sk_live_abc1...')",
               existing_comment="First 8 characters of key for display (e.g., 'sk_live_')",
               existing_nullable=False)
    op.drop_constraint(op.f('api_keys_key_key'), 'api_keys', type_='unique')
    op.drop_index(op.f('ix_api_keys_key'), table_name='api_keys')
    op.create_index(op.f('ix_api_keys_key'), 'api_keys', ['key'], unique=True)
    op.add_column('experiments', sa.Column('is_recurring', sa.Boolean(), nullable=False, server_default=sa.text('false'), comment='Whether to run this experiment periodically'))
    op.add_column('experiments', sa.Column('frequency', sa.String(length=20), nullable=True, comment='Frequency: daily, weekly, monthly'))
    op.add_column('experiments', sa.Column('next_run_at', sa.DateTime(timezone=True), nullable=True, comment='Next scheduled execution time'))
    op.add_column('experiments', sa.Column('last_run_at', sa.DateTime(timezone=True), nullable=True, comment='Last execution time'))
    op.alter_column('experiments', 'user_id',
               existing_type=sa.UUID(),
               nullable=False,
               existing_comment='User who created this experiment')
    op.create_index(op.f('ix_experiments_next_run_at'), 'experiments', ['next_run_at'], unique=False)
    op.alter_column('users', 'monthly_prompt_quota',
               existing_type=sa.INTEGER(),
               comment='Monthly prompt quota based on pricing tier (each prompt runs 10 iterations)',
               existing_comment='Monthly iteration quota based on pricing tier',
               existing_nullable=False)
    op.alter_column('users', 'prompts_used_this_month',
               existing_type=sa.INTEGER(),
               comment='Prompts (experiments) used in current billing period',
               existing_comment='Iterations used in current billing period',
               existing_nullable=False)
    op.drop_constraint(op.f('users_email_key'), 'users', type_='unique')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=False)
    op.create_unique_constraint(op.f('users_email_key'), 'users', ['email'], postgresql_nulls_not_distinct=False)
    op.alter_column('users', 'prompts_used_this_month',
               existing_type=sa.INTEGER(),
               comment='Iterations used in current billing period',
               existing_comment='Prompts (experiments) used in current billing period',
               existing_nullable=False)
    op.alter_column('users', 'monthly_prompt_quota',
               existing_type=sa.INTEGER(),
               comment='Monthly iteration quota based on pricing tier',
               existing_comment='Monthly prompt quota based on pricing tier (each prompt runs 10 iterations)',
               existing_nullable=False)
    op.drop_index(op.f('ix_experiments_next_run_at'), table_name='experiments')
    op.alter_column('experiments', 'user_id',
               existing_type=sa.UUID(),
               nullable=True,
               existing_comment='User who created this experiment')
    op.drop_column('experiments', 'last_run_at')
    op.drop_column('experiments', 'next_run_at')
    op.drop_column('experiments', 'frequency')
    op.drop_column('experiments', 'is_recurring')
    op.drop_index(op.f('ix_api_keys_key'), table_name='api_keys')
    op.create_index(op.f('ix_api_keys_key'), 'api_keys', ['key'], unique=False)
    op.create_unique_constraint(op.f('api_keys_key_key'), 'api_keys', ['key'], postgresql_nulls_not_distinct=False)
    op.alter_column('api_keys', 'prefix',
               existing_type=sa.String(length=20),
               type_=sa.VARCHAR(length=10),
               comment="First 8 characters of key for display (e.g., 'sk_live_')",
               existing_comment="Display prefix of key (e.g., 'sk_live_abc1...')",
               existing_nullable=False)
    # ### end Alembic commands ###
